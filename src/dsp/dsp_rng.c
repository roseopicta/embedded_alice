// Author: Emilie Gillet (emilie.gillet@etu.sorbonne-universite.fr)
//
// -----------------------------------------------------------------------------
//
// Digital signal processing routines - Random number generator.

#include "dsp/dsp_rng.h"

#include <math.h>
#include <stdio.h>

void dsp_rng_init(
        rng_state_t* state,
        uint32_t scale,
        uint32_t max_magnitude,
        bool clamp,
        uint32_t seed,
        uint32_t mask) {
    state->scale = scale;
    state->max_magnitude = max_magnitude;
    state->clamp = clamp;
    dsp_rng_reset(state, seed, mask);
}

void dsp_rng_reset(
        rng_state_t* state,
        uint32_t seed,
        uint32_t mask) {
    state->state = seed;
    state->mask = mask & RNG_RAND_MAX;
}

#define CLAMP(v, mag) v = v > (mag) ? (mag) : (v < -(mag) ? -(mag) : v);

void dsp_rng_generate_box_muller(
    rng_state_t* state,
    iq_sample_t* out,
    size_t size) {

    rng_state_t s = *state;

    float scale = (float)(s.scale);
    while (size--) {
        int32_t i, q;
        do {
            float u, v, norm;
            do {
                u = 2.0f * dsp_rng_uniform_float(&s) - 1.0f;
                v = 2.0f * dsp_rng_uniform_float(&s) - 1.0f;
                norm = u * u + v * v;
            } while (norm == 0.0f || norm >= 1.0f);
            float r = sqrtf(-2.0f * logf(norm) / norm) * scale;
            i = u * r;
            q = v * r;
        } while ((abs(i) > s.max_magnitude || abs(q) > s.max_magnitude) && !s.clamp);
        if (s.clamp) {
            CLAMP(i, (int32_t)(s.max_magnitude));
            CLAMP(q, (int32_t)(s.max_magnitude));
        }
        *out++ = (iq_sample_t) { i, q };
    }

    *state = s;
}

#define LUT_GAUSSIAN_ICDF_SEGMENT_SIZE 256
#define LUT_GAUSSIAN_ICDF_SHIFT_BY 4
#define LUT_GAUSSIAN_ICDF_NUM_SHIFTS 4
#define LUT_GAUSSIAN_ICDF_SIZE 1028

const int32_t lut_gaussian_icdf[LUT_GAUSSIAN_ICDF_SIZE] = {
         -524287,         -189112,         -174330,         -165183,
         -158437,         -153041,         -148519,         -144610,
         -141156,         -138055,         -135235,         -132645,
         -130248,         -128013,         -125917,         -123943,
         -122075,         -120302,         -118613,         -116998,
         -115452,         -113968,         -112540,         -111163,
         -109834,         -108548,         -107303,         -106096,
         -104923,         -103783,         -102674,         -101593,
         -100540,          -99511,          -98507,          -97525,
          -96565,          -95625,          -94704,          -93801,
          -92916,          -92048,          -91195,          -90358,
          -89535,          -88726,          -87930,          -87147,
          -86377,          -85618,          -84870,          -84133,
          -83407,          -82691,          -81984,          -81287,
          -80600,          -79920,          -79250,          -78587,
          -77933,          -77286,          -76646,          -76014,
          -75389,          -74770,          -74159,          -73553,
          -72954,          -72361,          -71773,          -71192,
          -70616,          -70045,          -69479,          -68919,
          -68364,          -67813,          -67268,          -66727,
          -66190,          -65658,          -65130,          -64607,
          -64087,          -63571,          -63060,          -62552,
          -62048,          -61547,          -61050,          -60557,
          -60067,          -59580,          -59097,          -58617,
          -58140,          -57666,          -57194,          -56726,
          -56261,          -55799,          -55339,          -54882,
          -54428,          -53976,          -53527,          -53080,
          -52636,          -52194,          -51755,          -51318,
          -50883,          -50450,          -50020,          -49592,
          -49166,          -48742,          -48319,          -47899,
          -47481,          -47065,          -46651,          -46238,
          -45828,          -45419,          -45012,          -44606,
          -44203,          -43801,          -43401,          -43002,
          -42605,          -42209,          -41815,          -41423,
          -41032,          -40642,          -40254,          -39867,
          -39482,          -39098,          -38715,          -38334,
          -37954,          -37575,          -37197,          -36821,
          -36446,          -36072,          -35699,          -35327,
          -34957,          -34588,          -34219,          -33852,
          -33486,          -33121,          -32757,          -32394,
          -32032,          -31671,          -31311,          -30952,
          -30593,          -30236,          -29880,          -29524,
          -29169,          -28816,          -28463,          -28110,
          -27759,          -27408,          -27059,          -26710,
          -26361,          -26014,          -25667,          -25321,
          -24976,          -24631,          -24287,          -23944,
          -23601,          -23259,          -22918,          -22577,
          -22237,          -21897,          -21558,          -21220,
          -20882,          -20545,          -20208,          -19872,
          -19536,          -19201,          -18866,          -18532,
          -18198,          -17865,          -17532,          -17200,
          -16868,          -16537,          -16206,          -15875,
          -15545,          -15215,          -14886,          -14557,
          -14228,          -13899,          -13572,          -13244,
          -12917,          -12590,          -12263,          -11937,
          -11611,          -11285,          -10959,          -10634,
          -10309,           -9984,           -9660,           -9336,
           -9012,           -8688,           -8364,           -8041,
           -7718,           -7395,           -7072,           -6749,
           -6427,           -6104,           -5782,           -5460,
           -5138,           -4817,           -4495,           -4173,
           -3852,           -3531,           -3209,           -2888,
           -2567,           -2246,           -1925,           -1604,
           -1283,            -962,            -641,            -320,
               0,         -524287,         -240407,         -228530,
         -221324,         -216084,         -211943,         -208506,
         -205562,         -202982,         -200683,         -198607,
         -196713,         -194970,         -193356,         -191850,
         -190440,         -189112,         -187858,         -186670,
         -185539,         -184461,         -183431,         -182445,
         -181498,         -180587,         -179710,         -178864,
         -178047,         -177257,         -176491,         -175749,
         -175029,         -174330,         -173649,         -172987,
         -172342,         -171714,         -171101,         -170502,
         -169917,         -169346,         -168787,         -168240,
         -167705,         -167180,         -166666,         -166162,
         -165668,         -165183,         -164707,         -164239,
         -163780,         -163329,         -162885,         -162448,
         -162019,         -161596,         -161180,         -160771,
         -160367,         -159970,         -159578,         -159192,
         -158812,         -158437,         -158067,         -157701,
         -157341,         -156985,         -156634,         -156288,
         -155945,         -155607,         -155273,         -154943,
         -154617,         -154295,         -153976,         -153661,
         -153349,         -153041,         -152737,         -152435,
         -152137,         -151842,         -151549,         -151260,
         -150974,         -150691,         -150410,         -150132,
         -149857,         -149584,         -149314,         -149047,
         -148782,         -148519,         -148259,         -148001,
         -147745,         -147492,         -147240,         -146991,
         -146744,         -146499,         -146256,         -146015,
         -145776,         -145539,         -145304,         -145071,
         -144839,         -144610,         -144382,         -144155,
         -143931,         -143708,         -143487,         -143267,
         -143050,         -142833,         -142618,         -142405,
         -142193,         -141983,         -141774,         -141567,
         -141360,         -141156,         -140953,         -140751,
         -140550,         -140351,         -140153,         -139956,
         -139760,         -139566,         -139373,         -139181,
         -138991,         -138801,         -138613,         -138426,
         -138240,         -138055,         -137871,         -137688,
         -137506,         -137326,         -137146,         -136967,
         -136790,         -136613,         -136438,         -136263,
         -136089,         -135916,         -135745,         -135574,
         -135404,         -135235,         -135067,         -134899,
         -134733,         -134568,         -134403,         -134239,
         -134076,         -133914,         -133753,         -133592,
         -133432,         -133273,         -133115,         -132958,
         -132801,         -132645,         -132490,         -132336,
         -132182,         -132029,         -131877,         -131725,
         -131575,         -131424,         -131275,         -131126,
         -130978,         -130831,         -130684,         -130538,
         -130392,         -130248,         -130103,         -129960,
         -129817,         -129675,         -129533,         -129392,
         -129251,         -129111,         -128972,         -128833,
         -128695,         -128557,         -128420,         -128284,
         -128148,         -128013,         -127878,         -127743,
         -127610,         -127476,         -127344,         -127211,
         -127080,         -126949,         -126818,         -126688,
         -126558,         -126429,         -126300,         -126172,
         -126044,         -125917,         -125790,         -125664,
         -125538,         -125413,         -125288,         -125164,
         -125040,         -124916,         -124793,         -124670,
         -124548,         -124426,         -124305,         -124184,
         -124063,         -123943,         -123823,         -123704,
         -123585,         -123467,         -123349,         -123231,
         -123114,         -122997,         -122880,         -122764,
         -122648,         -122533,         -122418,         -122304,
         -122189,         -122075,         -524287,         -283437,
         -273256,         -267138,         -262718,         -259244,
         -256373,         -253924,         -251784,         -249884,
         -248172,         -246615,         -245186,         -243865,
         -242636,         -241487,         -240407,         -239389,
         -238426,         -237512,         -236641,         -235811,
         -235016,         -234255,         -233524,         -232822,
         -232144,         -231491,         -230860,         -230250,
         -229659,         -229086,         -228530,         -227990,
         -227466,         -226955,         -226458,         -225973,
         -225501,         -225040,         -224590,         -224150,
         -223720,         -223299,         -222888,         -222485,
         -222090,         -221703,         -221324,         -220952,
         -220587,         -220229,         -219877,         -219532,
         -219192,         -218858,         -218530,         -218207,
         -217890,         -217577,         -217269,         -216966,
         -216668,         -216374,         -216084,         -215799,
         -215517,         -215240,         -214966,         -214696,
         -214429,         -214167,         -213907,         -213651,
         -213398,         -213148,         -212901,         -212657,
         -212416,         -212178,         -211943,         -211710,
         -211480,         -211253,         -211028,         -210805,
         -210585,         -210368,         -210152,         -209939,
         -209728,         -209519,         -209313,         -209108,
         -208906,         -208705,         -208506,         -208309,
         -208114,         -207921,         -207730,         -207540,
         -207353,         -207166,         -206982,         -206799,
         -206618,         -206438,         -206260,         -206083,
         -205908,         -205734,         -205562,         -205391,
         -205222,         -205054,         -204887,         -204721,
         -204557,         -204394,         -204233,         -204072,
         -203913,         -203755,         -203598,         -203442,
         -203288,         -203134,         -202982,         -202831,
         -202681,         -202532,         -202384,         -202237,
         -202091,         -201946,         -201802,         -201658,
         -201516,         -201375,         -201235,         -201096,
         -200957,         -200820,         -200683,         -200547,
         -200412,         -200278,         -200145,         -200012,
         -199881,         -199750,         -199620,         -199491,
         -199362,         -199235,         -199108,         -198981,
         -198856,         -198731,         -198607,         -198484,
         -198361,         -198239,         -198118,         -197997,
         -197877,         -197758,         -197639,         -197521,
         -197404,         -197287,         -197171,         -197056,
         -196941,         -196827,         -196713,         -196600,
         -196488,         -196376,         -196264,         -196154,
         -196043,         -195934,         -195824,         -195716,
         -195608,         -195500,         -195393,         -195287,
         -195181,         -195075,         -194970,         -194866,
         -194762,         -194659,         -194556,         -194453,
         -194351,         -194249,         -194148,         -194048,
         -193947,         -193848,         -193748,         -193650,
         -193551,         -193453,         -193356,         -193259,
         -193162,         -193066,         -192970,         -192874,
         -192779,         -192685,         -192590,         -192496,
         -192403,         -192310,         -192217,         -192125,
         -192033,         -191941,         -191850,         -191760,
         -191669,         -191579,         -191489,         -191400,
         -191311,         -191222,         -191134,         -191046,
         -190958,         -190871,         -190784,         -190698,
         -190611,         -190525,         -190440,         -190355,
         -190270,         -190185,         -190101,         -190017,
         -189933,         -189850,         -189766,         -189684,
         -189601,         -189519,         -189437,         -189356,
         -189274,         -189193,         -189112,         -524287,
         -321189,         -312148,         -306744,         -302856,
         -299809,         -297298,         -295159,         -293295,
         -291641,         -290155,         -288804,         -287566,
         -286423,         -285361,         -284368,         -283437,
         -282560,         -281731,         -280945,         -280197,
         -279484,         -278802,         -278149,         -277523,
         -276921,         -276342,         -275784,         -275244,
         -274723,         -274219,         -273730,         -273256,
         -272796,         -272349,         -271915,         -271492,
         -271080,         -270678,         -270287,         -269905,
         -269531,         -269167,         -268810,         -268461,
         -268120,         -267786,         -267459,         -267138,
         -266823,         -266515,         -266212,         -265915,
         -265623,         -265336,         -265055,         -264778,
         -264506,         -264238,         -263975,         -263716,
         -263461,         -263209,         -262962,         -262718,
         -262478,         -262242,         -262008,         -261779,
         -261552,         -261328,         -261107,         -260890,
         -260675,         -260462,         -260253,         -260046,
         -259842,         -259640,         -259441,         -259244,
         -259049,         -258857,         -258666,         -258478,
         -258292,         -258109,         -257927,         -257747,
         -257569,         -257393,         -257218,         -257046,
         -256875,         -256706,         -256539,         -256373,
         -256209,         -256047,         -255886,         -255727,
         -255569,         -255412,         -255257,         -255104,
         -254952,         -254801,         -254652,         -254503,
         -254357,         -254211,         -254067,         -253924,
         -253782,         -253641,         -253501,         -253363,
         -253226,         -253089,         -252954,         -252820,
         -252687,         -252555,         -252424,         -252294,
         -252165,         -252037,         -251910,         -251784,
         -251659,         -251535,         -251411,         -251289,
         -251167,         -251047,         -250927,         -250808,
         -250689,         -250572,         -250455,         -250339,
         -250224,         -250110,         -249996,         -249884,
         -249772,         -249660,         -249550,         -249440,
         -249330,         -249222,         -249114,         -249007,
         -248900,         -248794,         -248689,         -248585,
         -248481,         -248377,         -248275,         -248172,
         -248071,         -247970,         -247870,         -247770,
         -247671,         -247572,         -247474,         -247377,
         -247280,         -247183,         -247087,         -246992,
         -246897,         -246803,         -246709,         -246615,
         -246523,         -246430,         -246338,         -246247,
         -246156,         -246066,         -245976,         -245886,
         -245797,         -245709,         -245620,         -245533,
         -245445,         -245359,         -245272,         -245186,
         -245101,         -245016,         -244931,         -244846,
         -244763,         -244679,         -244596,         -244513,
         -244431,         -244349,         -244267,         -244186,
         -244105,         -244025,         -243945,         -243865,
         -243786,         -243706,         -243628,         -243550,
         -243472,         -243394,         -243317,         -243240,
         -243163,         -243087,         -243011,         -242935,
         -242860,         -242785,         -242710,         -242636,
         -242562,         -242488,         -242415,         -242341,
         -242269,         -242196,         -242124,         -242052,
         -241980,         -241909,         -241838,         -241767,
         -241696,         -241626,         -241556,         -241487,
         -241417,         -241348,         -241279,         -241211,
         -241142,         -241074,         -241006,         -240939,
         -240871,         -240804,         -240737,         -240671,
         -240605,         -240539,         -240473,         -240407
};

inline int32_t dsp_rng_uniform_to_gaussian(uint32_t u) {
    // Use first bit for sign.
    int32_t sign = u & 0x80000000 ? -1 : 1;
    if (u & 0x80000000) {
        u = ~u;
    }
    u <<= 1;

    // Identify if we are in the first 4096-tile, 256-tile or 16-tile.
    // In these case, use the appropriate table.
    const int32_t* lut = lut_gaussian_icdf;
    size_t shifts = 0;
    while ((u >> (32 - LUT_GAUSSIAN_ICDF_SHIFT_BY)) == 0 && \
           shifts < (LUT_GAUSSIAN_ICDF_NUM_SHIFTS - 1)) {
        u <<= LUT_GAUSSIAN_ICDF_SHIFT_BY;
        lut += LUT_GAUSSIAN_ICDF_SEGMENT_SIZE + 1;
        ++shifts;
    }

    uint32_t integral = u >> 24;
    int32_t fractional = (u << 8) >> 20;
    int32_t a = lut[integral];
    int32_t b = lut[integral + 1];
    return (a + ((b - a) * fractional >> 12)) * sign;
}

void dsp_rng_generate_icdf(
        rng_state_t* state,
        iq_sample_t* out,
        size_t size) {
    rng_state_t s = *state;
    int32_t scale = s.scale >> 4;
    while (size--) {
        int32_t samples[2];
        for (int32_t i = 0; i < 2; ++i) {
            int32_t sample;
            do {
                uint32_t u = dsp_rng_uniform_u32(&s);
                sample = dsp_rng_uniform_to_gaussian(u);
                sample = sample * scale >> 12;
            } while (abs(sample) > s.max_magnitude && !s.clamp);
            if (s.clamp) {
                CLAMP(sample, (int32_t)(s.max_magnitude));
            }
            samples[i] = sample;
        }
        *out++ = (iq_sample_t) { samples[0], samples[1] };
    }
    *state = s;
}
